[package]
name = "docling-pdf-ml"
version.workspace = true
edition.workspace = true
license.workspace = true
repository.workspace = true
description = "ML-based PDF parsing library with layout detection, OCR, and table extraction"
keywords = ["pdf", "parsing", "ml", "document", "layout"]
categories = ["parsing", "science"]
rust-version = "1.80"

[lib]
name = "docling_pdf_ml"
path = "src/lib.rs"

[features]
# Debug features (disabled by default for zero runtime overhead)
debug-trace = []        # Execution tracing (DEBUG_E2E_TRACE env var)
debug-profiling = []    # Performance profiling (PROFILE_* env vars)
debug-stats = []        # Statistics output (table/picture counts)

# ML model backends (will be enabled in later phases)
# NOTE: pytorch feature gates TableFormer, CodeFormula, and PyTorch layout backend
pytorch = ["dep:tch", "dep:tokenizers", "dep:safetensors", "dep:bytemuck", "dep:half", "dep:lazy_static"]
# OpenCV for OCR postprocessing - requires libclang at build time
opencv-preprocessing = ["dep:opencv"]
# CoreML backend for Apple Neural Engine acceleration (macOS only)
coreml = ["dep:coreml-rs", "dep:ndarray_015"]

[dependencies]
# Internal dependencies
docling-core = { path = "../docling-core" }

# ONNX Runtime for Models 1-2 (RapidOCR, LayoutPredictor)
ort = { workspace = true, features = ["ndarray"] }

# PyTorch bindings for Model 3 (TableFormer) and Model 4 (CodeFormula)
# NOTE: tch 0.22 requires PyTorch 2.9 (verified compatible 2025-12-04)
tch = { version = "0.22", optional = true }

# Tokenizers for Model 4 (CodeFormula) - HuggingFace tokenizers in Rust
tokenizers = { version = "0.20", optional = true }
# lazy_static for compile-time regex in CodeFormula tokenizer
lazy_static = { version = "1.4", optional = true }

# SafeTensors for cross-language ML model loading
safetensors = { version = "0.6", optional = true }
bytemuck = { version = "1.14", optional = true }  # Safe byte casting for SafeTensors â†’ Tensor conversion
half = { version = "2.3", features = ["bytemuck"], optional = true }  # F16 support for SafeTensors

# Data handling
ndarray.workspace = true
ndarray-npy = "0.9"
image.workspace = true
serde.workspace = true
serde_json.workspace = true
regex = "1.10"  # For text sanitization in page assembly
once_cell = "1.19"  # Lazy static initialization for regex patterns
rstar = "0.12"  # R-tree spatial indexing for layout post-processor
dirs = "5.0"  # Cross-platform cache directory resolution for model paths

# Logging
log = "0.4"  # Logging facade - debug!/info!/warn!/error! macros
env_logger = "0.11"  # Logger implementation for binaries and examples

# Performance optimization
rustc-hash = "2.0"      # FxHashMap for integer keys (2-4x faster than std HashMap)
ordered-float = "4.2"   # OrderedFloat for hashable floats

# RapidOCR postprocessing
geo-clipper = "0.8"     # Polygon offset for UnClip algorithm
geo = "0.28"            # Geometry primitives
imageproc.workspace = true  # Pure Rust image processing (contours, morphology)

# Numpy file reading
npyz = "0.8"

# CPU detection for ONNX Runtime thread optimization
num_cpus = "1.16"

# jemalloc allocator for better memory performance
tikv-jemallocator = "0.6"

# OpenCV for exact preprocessing match (C++ allowed per CLAUDE.md)
# NOTE: Optional - requires libclang at build time
opencv = { version = "0.97", features = ["imgproc"], optional = true }

# CoreML bindings for Apple Neural Engine acceleration (macOS only)
# Uses swift-bridge for FFI to maximize performance
coreml-rs = { version = "0.5", optional = true }
# ndarray 0.15 for coreml-rs compatibility (coreml-rs uses 0.15, we use 0.16)
ndarray_015 = { package = "ndarray", version = "0.15", optional = true }

# Error handling
thiserror.workspace = true
anyhow.workspace = true

[dev-dependencies]
rstest = "0.18"  # Parameterized tests for multi-page validation

# Lint configuration
[lints.clippy]
# Allow cosmetic/test-specific warnings
empty_line_after_doc_comments = "allow"
# Test files often have complex types for loading baseline data
type_complexity = "allow"
# Test files may have PathBuf parameters for consistency
ptr_arg = "allow"

[lints.rust]
# Test/debug files may have unused helper functions
dead_code = "allow"
# Test files may load data into variables for debugging
unused_variables = "allow"
