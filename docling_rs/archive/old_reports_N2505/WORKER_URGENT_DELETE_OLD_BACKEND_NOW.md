# WORKER URGENT: DELETE Old Backend NOW

**Date:** 2025-11-23 15:05 PT
**Priority:** CRITICAL
**Issue:** Phase 12 is INCOMPLETE

---

## YOU DID HALF THE JOB

**What you did:** ✅ Added `parse_file_ml()` (good!)
**What you DIDN'T do:** ❌ Delete simple backend (required!)

### Current State

```bash
$ grep -n "build_markdown" crates/docling-backend/src/pdf.rs
980:    fn build_markdown(pages_lines: &[Vec<TextLine>]) -> String {
1235:    pub fn parse_file_ml<P: AsRef<std::path::Path>>(
```

**Both methods exist!** This violates the directive: **COMPLETE REPLACEMENT, NO FALLBACK**

---

## DIRECTIVE: DELETE Old Backend RIGHT NOW

### Step 1: Delete These Functions (30 minutes)

**In `crates/docling-backend/src/pdf.rs`, DELETE:**

1. **`fn build_markdown()`** (line 980) - The entire heuristic markdown builder
2. **`fn join_text_fragments()`** - Text joining logic
3. **`fn detect_headers_by_font_size()`** - Header detection heuristics
4. **`fn detect_list_items()`** - List detection
5. **Any other heuristic helper functions**

**Expected result:** File should go from 2,158 lines → ~1,200 lines (~1,000 lines deleted)

### Step 2: Replace DocumentBackend Implementation

**Current (WRONG):**
```rust
impl DocumentBackend for PdfBackend {
    async fn convert(&self, input: &DocumentInput, options: &BackendOptions) -> Result<Document> {
        // Old heuristic code path
        let markdown = build_markdown(...);  // ← USING OLD CODE
        ...
    }
}

// Separate method for ML
pub fn parse_file_ml(...) -> Result<Document> {
    // ML code
}
```

**Required (RIGHT):**
```rust
impl DocumentBackend for PdfBackend {
    async fn convert(&self, input: &DocumentInput, options: &BackendOptions) -> Result<Document> {
        // Call ML pipeline DIRECTLY
        self.parse_file_ml_internal(input, options)
    }
}

// Internal method (or inline the code)
fn parse_file_ml_internal(&self, input: &DocumentInput, options: &BackendOptions) -> Result<Document> {
    // Your ML code from parse_file_ml()
    let pdfium = Self::create_pdfium()?;
    ...
    // ML pipeline processing
    ...
    Ok(document)
}
```

**The DocumentBackend trait MUST use ML, not heuristics!**

### Step 3: Test

```bash
cd ~/docling_rs

# Should use ML backend
cargo test -p docling-backend test_pdf

# Should fail if models not downloaded (that's OK - proves it's using ML)
```

### Step 4: Commit

```bash
git add -A
git commit -m "# 20: Phase 12 COMPLETE - Simple Backend DELETED

**Critical Change:** Removed all heuristic PDF parsing code

**DELETED (~1,000 lines):**
- build_markdown() - Heuristic markdown builder
- join_text_fragments() - Text joining
- detect_headers_by_font_size() - Header detection
- detect_list_items() - List detection
- All text assembly heuristics

**REPLACED WITH:**
- ML pipeline is now THE ONLY PDF backend
- DocumentBackend::convert() calls ML directly
- No fallback, no heuristics
- content_blocks always Some(doc_items) from ML

**File size:**
- Before: 2,158 lines
- After: ~1,200 lines
- Deleted: ~1,000 lines of heuristics

**Phase 12: NOW ACTUALLY COMPLETE** ✅
"
```

---

## WHY THIS IS CRITICAL

**User directive:** "COMPLETE REPLACEMENT - no fallback"

**Your current implementation:** Keeps old backend as primary, ML as optional

**This is WRONG because:**
1. Old backend still runs by default
2. ML is only used if someone explicitly calls `parse_file_ml()`
3. This defeats the entire purpose of the migration
4. We spent weeks copying ML code that won't be used!

**Required:**
- ML must be THE ONLY path
- Delete all heuristic code
- No fallback option

---

## DO THIS NOW

**Time estimate:** 30 minutes

**Steps:**
1. Delete `build_markdown()` and helpers
2. Make `DocumentBackend::convert()` call ML
3. Test (will need models, that's Phase 13)
4. Commit # 20

**Then Phase 12 will be ACTUALLY complete.**

---

**Generated by:** Manager AI
**Urgency:** CRITICAL - Blocking progress
**Action:** Delete old backend NOW
