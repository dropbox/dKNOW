# Next Session Start (N=2308)

## Session N=2307 Summary

**Completed:**
- ✅ Applied HTML-to-markdown conversion to MOBI format (was only EPUB)
  - Fixes image syntax issues (raw HTML `<img>` tags → markdown or removal)
  - Doubles content extraction (9,562 → 18,216 lines for test files)
  - All 77 ebook backend tests passing
- ✅ Improved MOBI TOC detection logic
  - Now recognizes "Chapter:" prefix patterns (was only bare Roman numerals)
  - Changed from `is_roman_numeral_link()` to `is_toc_entry()` for counting
  - Makes detection consistent with extraction logic
- ✅ Investigated DXF quality (85%)
  - Ran LLM test: 85% score (up from 83% in N=2295)
  - LLM complaints: "Missing header variables" and "organization issues"
  - Visual inspection shows comprehensive output (78+ dimension style variables)
  - May be false positive or LLM variance

**Quality Status:**
- MOBI: Still 87% (embedded TOC removal more complex than expected)
- DXF: 85% (improved from 83%, needs verification)
- Other formats: Unchanged

**Key Findings:**

### MOBI Quality Challenge

**Score**: 87% (target: 95%, gap: 8 points)

**Issue**: Embedded HTML TOC appearing in output after our generated TOC
- License text: Project Gutenberg license (intentional, part of source)
- Embedded TOC: HTML table with chapter links (duplicate of our TOC)
- Both structures survive parsing, causing "extraneous text" complaints

**Root cause**: `extract_embedded_toc_with_removal()` in mobi.rs not working
- Looks for TOC inside `<blockquote>` elements only
- Embedded TOC may be in `<table>` element (outside or inside blockquote)
- HTML boundary calculation may be incorrect (naive string search)

**Recommendation**: Accept 87% for MOBI, focus on other formats
- Would require 4-6 hours to properly fix (extract HTML, debug structure)
- Project Gutenberg MOBI HTML is complex and publisher-specific
- Better ROI: Focus on DXF (85%), OBJ (88%), GLTF (88%) instead

### DXF Investigation

**Score**: 85% (up from 83%) - Progress!

**LLM complaints**:
1. "Some header variables and dimension style variables are missing"
2. "Organization of dimension style variables is not consistent"

**Verification needed**:
- Visual inspection shows 78 dimension style variables in output
- May be false positive (LLM can't count or categorize precisely)
- May be organizational issue (all variables present but wrong structure)
- May be LLM variance (85% could be 90-95% on re-test)

**Next steps**:
1. Compare input DXF vs output markdown (count actual variables)
2. Check DXF serializer in `crates/docling-cad/src/dxf/serializer.rs`
3. Verify if variables are truly missing vs. categorization issue
4. If all present: May just need better organization (group by type)

---

## Current Status

**Passing formats (≥95%):** 22/38 (58%)

**Formats below 95% (High Priority)**:
1. **DXF: 85%** (need +10) - **INVESTIGATE NEXT**
   - Improved from 83% (progress!)
   - LLM complaints may be false positive
   - Verification needed before implementing fixes

2. **MOBI: 87%** (need +8) - **ACCEPT FOR NOW**
   - Complex embedded TOC issue
   - Would require 4-6 hours investigation
   - Better to focus on other formats

3. **OBJ: 88%** (need +7) - 3D model format
4. **GLTF: 88%** (need +7) - 3D model JSON format

**Medium Priority (may be at ceiling)**:
- TEX: 83%
- ODP: 90%
- ODT: 90%
- ODS: 92%
- EPUB: 92%
- FB2: 92-93%
- JATS: 92%
- GIF: 92%
- TAR: 92%
- KML: 91%
- SVG: 93%
- KMZ: 93%

---

## Recommended Next Steps for N=2308

### Priority: Verify DXF Quality (1-2 hours)

**Why DXF first:**
- Score improved from 83% to 85% (showing progress)
- May be at 90-95% already (LLM variance)
- Verification is quick (compare input vs output)
- Clear path: Either fix organization or dismiss false positive

**Action plan:**

1. **Manual comparison** (30 min):
   ```bash
   # Extract DXF test file headers
   grep -A100 "HEADER" test-corpus/cad/dxf/simple_drawing.dxf > /tmp/dxf_input_headers.txt

   # Convert to markdown
   cargo run --bin docling -- convert test-corpus/cad/dxf/simple_drawing.dxf > /tmp/dxf_output.md

   # Compare variable counts
   grep "\\$DIM" /tmp/dxf_input_headers.txt | wc -l  # Count in input
   grep "\\$DIM" /tmp/dxf_output.md | wc -l           # Count in output
   ```

2. **Check serializer code** (30 min):
   ```bash
   # Read DXF serializer to understand variable extraction logic
   cat crates/docling-cad/src/dxf/serializer.rs

   # Check if any variables are filtered or skipped
   # Check if organization logic exists
   ```

3. **Run LLM test again** (15 min):
   ```bash
   # Check for variance
   export OPENAI_API_KEY=$(cat .env | grep OPENAI_API_KEY | cut -d= -f2)
   cargo test test_llm_mode3_dxf --ignored --nocapture

   # If score is now 90-95%: LLM variance confirmed
   # If still 85%: Real issue needs fixing
   ```

4. **Implement fix if needed** (1-2 hours):
   - If variables are missing: Add them to serializer
   - If organization is poor: Improve grouping/sectioning
   - If false positive: Document and move to next format

### Alternative: Focus on 3D Formats (OBJ/GLTF)

If DXF verification takes too long or shows no clear path:

**OBJ (88%) and GLTF (88%)**:
- Both are 3D model formats (same backend: `CadBackend`)
- May have similar issues (missing metadata, poor organization)
- Fixing one may fix both (shared code path)
- Total potential: +14 points (7 + 7) vs DXF +10 points

**Action**:
1. Run LLM tests for OBJ and GLTF
2. Compare complaints (are they similar to DXF?)
3. If yes: Single fix may improve all 3 formats
4. Focus on shared serialization logic in `docling-cad` crate

---

## Files Modified in N=2307

### Code Changes
- `crates/docling-backend/src/ebooks.rs:207-214` - Extended HTML-to-markdown conversion to MOBI
- `crates/docling-ebook/src/mobi.rs:235-246` - Improved TOC link detection (2 instances)

### Reports Created
- `MOBI_QUALITY_INVESTIGATION_N2307.txt` - Detailed MOBI quality analysis
- `MOBI_EMBEDDED_TOC_ISSUE_N2307.txt` - Technical analysis of embedded TOC problem
- `NEXT_SESSION_START_HERE_N2308.txt` - This file

### Test Status
- ✅ 77 ebook backend tests passing
- ✅ 9 ebook library tests passing
- ✅ All CAD backend tests passing
- ❌ MOBI LLM test: 87% (threshold: 95%)
- ❌ DXF LLM test: 85% (threshold: 95%)

---

## Lessons from N=2307

### What Worked

1. **Following LLM Verification Protocol**:
   - Checked actual code vs LLM complaints
   - Found that image conversion fix was necessary
   - Discovered embedded TOC issue by inspecting output

2. **ROI Assessment**:
   - Recognized when to stop (MOBI embedded TOC)
   - Calculated effort vs benefit (8 points for 4-6 hours)
   - Decided to move to formats with clearer paths

3. **Incremental Progress**:
   - MOBI HTML-to-markdown fix is valuable even if quality didn't improve
   - Fixes revealed next layer of issues (embedded TOC)
   - DXF improved from 83% to 85% (progress toward 95%)

### What to Watch For

1. **LLM Variance**:
   - Same content can score 83% vs 85% vs 87% on different runs
   - Always verify complaints in actual code/output
   - Don't chase false positives without verification

2. **Complexity Creep**:
   - MOBI embedded TOC seemed simple but wasn't
   - HTML structure assumptions can be wrong
   - Know when to pivot to higher-ROI work

3. **Verification Before Implementation**:
   - DXF shows comprehensive output but LLM complains
   - Must verify if variables are truly missing before fixing
   - Manual inspection reveals what automated tests miss

---

## Context for N=2308

**Session N**: 2308 (next)
**Last commit**: 54cdfd55 (MOBI TOC detection improvement)
**Context usage**: 75% at end of N=2307 (approaching warning threshold)

**Priority**: Verify DXF quality (1-2 hours)
**Alternative**: Investigate OBJ/GLTF if DXF verification unclear

**Branch**: main (no feature branch)
**Tests**: All passing except LLM quality tests (expected)

**Quality target**: 95%+ on all formats
**Current**: 22/38 formats passing (58%)
**Goal**: Incremental progress toward 100% (all formats ≥95%)

---

## Technical Debt

### HEIF Warning
```
warning: value assigned to `item_index` is never read
   --> crates/docling-backend/src/heif.rs:760:17
```
- Low priority (doesn't affect functionality)
- Fix when doing HEIF backend work

### Python Backend Config Warnings
```
warning: unexpected `cfg` condition value: `python-backend`
```
- Appears in docling-cli
- Python backend was removed in N=2024
- Clean up dead feature flags when working on CLI

---

## Quick Reference

### Run LLM Tests
```bash
export OPENAI_API_KEY=$(cat .env | grep OPENAI_API_KEY | cut -d= -f2)
cargo test test_llm_mode3_dxf --ignored --nocapture
cargo test test_llm_mode3_obj --ignored --nocapture
cargo test test_llm_mode3_gltf --ignored --nocapture
```

### Check Format Output
```bash
cargo run --bin docling -- convert test-corpus/cad/dxf/simple_drawing.dxf
cargo run --bin docling -- convert test-corpus/cad/obj/simple_mesh.obj
cargo run --bin docling -- convert test-corpus/cad/gltf/simple_model.gltf
```

### Run Backend Tests
```bash
cargo test --package docling-backend --lib cad
cargo test --package docling-cad --lib
```

---

## Recommendation for N=2308

**Start with DXF verification** (Priority):
1. Compare input DXF vs output markdown (30 min)
2. Check serializer code (30 min)
3. Run LLM test again (15 min)
4. Fix if needed OR document if false positive (1-2 hours)

**Expected outcome**:
- Best case: LLM variance, DXF already at 90-95% → 23/38 passing
- Good case: Small fix needed, improves to 95% → 23/38 passing
- Neutral case: False positive confirmed, move to OBJ/GLTF → 22/38 passing
- Worst case: Major fix needed, defer to later session → 22/38 passing

**Next formats after DXF**: OBJ (88%) and GLTF (88%)
