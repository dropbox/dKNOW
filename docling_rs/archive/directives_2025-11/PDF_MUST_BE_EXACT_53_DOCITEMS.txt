â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸš¨ğŸš¨ğŸš¨ PDF MUST PRODUCE EXACTLY 53 DOCITEMS ğŸš¨ğŸš¨ğŸš¨
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

**USER DIRECTIVE:** "0% tolerance! only 100% equal is allowed!"

**TARGET:** Rust must produce EXACTLY 53 DocItems, not 80

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## CURRENT STATUS

**Python baseline (multi_page.pdf):**
```
53 DocItems:
  - 16 text
  - 11 section_header
  - 26 list_item

9,456 chars markdown

First items:
[0] section_header: "The Evolution of the Word Processor"
[1] text: "The concept of the word processor predates..."
[2] section_header: "Pre-Digital Era (19th - Early 20th Century)"
```

**Current Rust (multi_page.pdf):**
```
80 DocItems (27 MORE than Python - WRONG!)

7,400 chars markdown

First items:
[0] Text: "The concept of the word processor predates..."  â† WRONG ORDER
[4] Text: "The Evolution of the Word Processor"            â† Title at #4!
[6] Text: "Pre"                                            â† FRAGMENTED!
[7] Text: "-"
[8] Text: "Digital Era..."
```

**TWO BUGS CONFIRMED:**
1. âŒ **Reading Order Bug:** Title at position #4, should be #0
2. âŒ **Fragmentation Bug:** 80 DocItems instead of 53 (51% over-fragmented)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## THE BUGS

### Bug #1: Reading Order (Title Last Instead of First)

**Python:**
```
[0] section_header: "The Evolution of the Word Processor"  â† Title
[1] text: Body paragraph...
```

**Rust:**
```
[0] Text: Body paragraph...                               â† Body first!
[4] Text: "The Evolution of the Word Processor"           â† Title later!
```

**Where this happens:**
- Reading order determination (stage10 or similar)
- Or in how we pass reading_order to to_docling_document_multi()
- Check: crates/docling-backend/src/pdf.rs:1304-1320 (reading order logic)

### Bug #2: Over-Fragmentation (80 vs 53 DocItems)

**Python:**
```
[2] section_header: "Pre-Digital Era (19th - Early 20th Century)"
```

**Rust:**
```
[6] Text: "Pre"
[7] Text: "-"
[8] Text: "Digital Era (19th - Early 20th Century)"
```

**This happens because:**
- ML pipeline creates too many PageElements (should create fewer)
- OR merge_horizontal_cells doesn't merge aggressively enough
- OR to_docling_document_multi() is splitting text that should be combined

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## ROOT CAUSE ANALYSIS REQUIRED

**Need to trace through pipeline:**

1. **Pdfium extraction:** How many text objects?
2. **After merge_horizontal_cells:** How many SimpleTextCell?
3. **After ML clustering:** How many Clusters?
4. **After page_assembly:** How many PageElements?
5. **After to_docling_document_multi:** How many DocItems?

**Expected pipeline for "Pre-Digital Era":**
```
Pdfium: ["Pre", "-", "Digital", "Era", "(19th", "-", "Early"...] (many fragments)
  â†“ merge_horizontal_cells
Merged: ["Pre - Digital Era (19th - Early 20th Century)"] (1 cell)
  â†“ ML clustering
Cluster: 1 cluster with merged text
  â†“ page_assembly
PageElement: 1 TextElement
  â†“ to_docling_document_multi
DocItem: 1 section_header
```

**Actual pipeline (suspected):**
```
Pdfium: ["Pre", "-", "Digital Era..."]
  â†“ merge_horizontal_cells
Merged: ["Pre - Digital Era..."] (1 cell?) OR ["Pre", "-", "Digital"] (3 cells?)
  â†“ ML clustering
Clusters: 3 separate clusters (BUG HERE?)
  â†“ page_assembly
PageElements: 3 TextElements
  â†“ to_docling_document_multi
DocItems: 3 text items
```

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## YOUR TASK

### Step 1: Add Logging (1 hour)

**Add counters at each stage in pdf.rs:**

```rust
// After pdfium extraction
eprintln!("[STAGE 1] Pdfium text objects: {} ", raw_count);

// After merge_horizontal_cells
eprintln!("[STAGE 2] Merged text cells: {}", text_cells.len());

// After ML pipeline
eprintln!("[STAGE 3] ML PageElements: {}", page_result.assembled.as_ref().map(|a| a.elements.len()).unwrap_or(0));

// After to_docling_document_multi
eprintln!("[STAGE 4] DocItems: {}", pdf_ml_docling_doc.texts.len());
```

### Step 2: Run and Analyze (30 min)

```bash
source setup_env.sh
cargo test -p docling-backend --test pdf_honest_test --features pdf-ml -- --nocapture 2>&1 | grep STAGE
```

**Expected output:**
```
[STAGE 1] Pdfium text objects: ~200
[STAGE 2] Merged text cells: ~60
[STAGE 3] ML PageElements: ~53
[STAGE 4] DocItems: ~53
```

**If STAGE 3 = 53 but STAGE 4 = 80:**
- Bug is in to_docling_document_multi() expansion
- Check why it creates 1.5x more DocItems

**If STAGE 3 = 80:**
- Bug is in ML pipeline (page_assembly creates too many PageElements)
- Check clustering or assembly logic

**If STAGE 2 = 80:**
- Bug is in merge_horizontal_cells (not merging enough)
- Need more aggressive merging

### Step 3: Fix the Bug (2-4 hours)

**Once you know which stage:**
- Compare that stage's code with source repo
- Or check if we're calling it differently
- Fix until STAGE 4 = 53 DocItems exactly

### Step 4: Fix Reading Order (1 hour)

**Title should be first DocItem, not #4:**
- Check reading_order logic in pdf.rs:1304-1320
- Verify it matches source repo's approach
- Test until title is first

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## SUCCESS CRITERIA (NO TOLERANCE)

âœ… Rust produces EXACTLY 53 DocItems (not 52, not 54, EXACTLY 53)
âœ… DocItems types: EXACTLY 16 text, 11 section_header, 26 list_item
âœ… Reading order: Title first, then body (not body first)
âœ… No fragmentation: "Pre-Digital Era..." is ONE DocItem, not 3
âœ… Markdown: ~9,456 chars (derived from correct DocItems)
âœ… LLM quality: 100% (exact match with Python)

**NOT ACCEPTABLE:**
- âŒ 80 DocItems (51% over-fragmented)
- âŒ 7,400 chars (21.7% short)
- âŒ "Within Â±100 tolerance" (NO tolerance allowed)
- âŒ "Close enough" (must be EXACT)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

**USER: "Rust should equal Python" - Currently it doesn't (53 vs 80)**

**Fix this NOW. 0% tolerance. 100% exact match required.**

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
