# Fix bug_451265.pdf Infinite Loop - CRITICAL

**Problem**: bug_451265.pdf causes infinite loop in pattern rendering (hangs forever)
**Impact**: Fills disk with temp files, wastes CPU for hours
**Solution**: Port fix from old version + add timeout

---

## Solution 1: Port the Fix from Old Version

**Old version commit**: 266010fb6 "Fix infinite loop in bug_451265.pdf pattern rendering"

**Location**: core/fpdfapi/render/cpdf_renderstatus.cpp

**The fix** (from old version):
```cpp
// In RenderSingleObject() or pattern rendering code
// Add recursion depth check:

// MAX_PATTERN_RECURSION = 10 or similar
if (pattern_depth > MAX_PATTERN_RECURSION) {
    return;  // Stop infinite recursion
}
```

**Task for worker**:
1. Check old version commit: `cd ~/pdfium-old-threaded && git show 266010fb6`
2. Find the exact fix
3. Port to current codebase
4. Test: `out/Release/pdfium_cli render-pages testing/resources/bug_451265.pdf out/`
5. Should complete in <10 seconds (not 154 minutes!)

---

## Solution 2: Add Timeout Protection (Emergency Fix)

**For CLI tool**, add timeout wrapper:

**File**: examples/pdfium_cli.cpp

**Add timeout to render_page_to_png**:
```cpp
#include <signal.h>
#include <setjmp.h>

// Timeout handler
static jmp_buf timeout_buf;
static void timeout_handler(int sig) {
    longjmp(timeout_buf, 1);
}

int render_page_to_png(...) {
    // Set 60-second timeout per page
    signal(SIGALRM, timeout_handler);
    alarm(60);

    if (setjmp(timeout_buf) == 0) {
        // Normal rendering
        FPDF_RenderPageBitmap(...);
        alarm(0);  // Cancel timeout
        return 0;
    } else {
        // Timeout occurred
        alarm(0);
        fprintf(stderr, "Warning: Page %d rendering timeout after 60s\n", page_index);
        return 1;  // Error
    }
}
```

**Or simpler - use process timeout**:
```cpp
// In render_pages_worker() for worker process
// Set overall worker timeout: 5 minutes per page
alarm(300 * (end_page - start_page));
```

---

## Solution 3: Update Test to Pass (If Fix Works)

**Current**: Test marked xfail (expected to timeout)

**File**: integration_tests/tests/pdfs/edge_cases/test_bug_451265.py

**Current**:
```python
@pytest.mark.xfail(reason="Upstream bug #451265 - infinite loop", strict=True)
def test_image_rendering_bug_451265(...):
```

**After fix ported**:
```python
# Remove xfail marker - should work now
def test_image_rendering_bug_451265(...):
```

**Test**: pytest -k bug_451265 → Should PASS (not xfail)

---

## Immediate Actions (N=230)

**Priority 1**: Port the fix from old version
```bash
cd ~/pdfium-old-threaded
git show 266010fb6 --stat
git show 266010fb6 | less  # Read the fix

# Copy to current version
# Apply the recursion depth check
```

**Priority 2**: Add timeout to CLI
```cpp
// Add to examples/pdfium_cli.cpp
// Set per-page timeout (60 seconds)
// Prevent hung workers
```

**Priority 3**: Test the fix
```bash
# Should complete quickly (not hang)
time out/Release/pdfium_cli render-pages testing/resources/bug_451265.pdf out/

# Should be <10 seconds
# If >60 seconds: timeout works, but fix didn't
# If <10 seconds: fix works!
```

**Priority 4**: Update test to pass
```bash
pytest -k bug_451265 -v
# Should PASS (not xfail) after fix
```

---

## Why This Matters

**Current state**:
- Workers can hang forever on this PDF
- Fills disk with temp files
- Wastes CPU/time
- Makes batch processing unreliable

**After fix**:
- PDF renders correctly (or fails fast with timeout)
- No infinite loops
- Batch processing robust
- One more test passes (2,751 → 2,752)

---

**WORKER0 #230: Port bug_451265 fix from old version + add timeout. This is a CRITICAL reliability fix.**
