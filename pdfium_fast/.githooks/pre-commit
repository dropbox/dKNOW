#!/bin/bash
# PDFium Pre-commit Hook
# Runs linters and tests before allowing commits
#
# To bypass (not recommended): git commit --no-verify

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

REPO_ROOT=$(git rev-parse --show-toplevel)
cd "$REPO_ROOT"

echo -e "${BLUE}======================================${NC}"
echo -e "${BLUE}PDFium Pre-commit Checks${NC}"
echo -e "${BLUE}======================================${NC}"
echo ""

FAILED=0

# ============================================================================
# 1. C++ Linting (clang-format)
# ============================================================================
CPP_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(cpp|cc|h|hpp)$' || true)

if [ -n "$CPP_FILES" ]; then
    echo -e "${YELLOW}[1/6] Checking C++ formatting...${NC}"

    if ! command -v clang-format &> /dev/null; then
        echo -e "${YELLOW}⚠️  clang-format not found, skipping C++ format check${NC}"
        echo -e "${YELLOW}   Install with: brew install clang-format${NC}"
    else
        # Check if .clang-format exists
        if [ ! -f .clang-format ]; then
            echo -e "${YELLOW}⚠️  No .clang-format config found, skipping${NC}"
        else
            FORMATTING_ISSUES=0
            for file in $CPP_FILES; do
                if [ -f "$file" ]; then
                    # Check if file needs formatting
                    if ! clang-format --dry-run --Werror "$file" 2>/dev/null; then
                        echo -e "${RED}  ❌ Formatting issues in: $file${NC}"
                        FORMATTING_ISSUES=1
                    fi
                fi
            done

            if [ $FORMATTING_ISSUES -eq 1 ]; then
                echo -e "${RED}❌ C++ formatting issues found!${NC}"
                echo -e "${YELLOW}Fix with: clang-format -i <files>${NC}"
                FAILED=1
            else
                echo -e "${GREEN}✓ C++ files properly formatted${NC}"
            fi
        fi
    fi
else
    echo -e "${BLUE}[1/6] No C++ files modified, skipping format check${NC}"
fi

echo ""

# ============================================================================
# 2. Python Linting
# ============================================================================
PY_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.py$' || true)

if [ -n "$PY_FILES" ]; then
    echo -e "${YELLOW}[2/6] Checking Python files...${NC}"

    # Try ruff first (modern, fast)
    if command -v ruff &> /dev/null; then
        echo -e "${BLUE}  Using ruff for Python linting...${NC}"

        # Check syntax errors and critical issues
        if ! ruff check --select=E9,F63,F7,F82 $PY_FILES 2>&1; then
            echo -e "${RED}❌ Python syntax/import errors found!${NC}"
            FAILED=1
        elif ! ruff check --select=E,W,F $PY_FILES 2>&1; then
            echo -e "${YELLOW}⚠️  Python lint warnings found (non-blocking)${NC}"
            echo -e "${YELLOW}   Fix with: ruff check --fix${NC}"
        else
            echo -e "${GREEN}✓ Python files pass lint checks${NC}"
        fi
    # Fallback to flake8
    elif command -v flake8 &> /dev/null; then
        echo -e "${BLUE}  Using flake8 for Python linting...${NC}"
        if ! flake8 $PY_FILES 2>&1; then
            echo -e "${YELLOW}⚠️  Python lint warnings found (non-blocking)${NC}"
        else
            echo -e "${GREEN}✓ Python files pass lint checks${NC}"
        fi
    # Fallback to basic Python syntax check
    else
        echo -e "${YELLOW}⚠️  No Python linter found (ruff/flake8), checking syntax only${NC}"
        echo -e "${YELLOW}   Install with: pip install ruff${NC}"
        for file in $PY_FILES; do
            if [ -f "$file" ]; then
                if ! python3 -m py_compile "$file" 2>&1; then
                    echo -e "${RED}❌ Syntax error in: $file${NC}"
                    FAILED=1
                fi
            fi
        done
        if [ $FAILED -eq 0 ]; then
            echo -e "${GREEN}✓ Python files have valid syntax${NC}"
        fi
    fi
else
    echo -e "${BLUE}[2/6] No Python files modified, skipping lint check${NC}"
fi

echo ""

# ============================================================================
# 3. Rust Linting (rustfmt and clippy)
# ============================================================================
RUST_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.rs$' || true)

if [ -n "$RUST_FILES" ]; then
    echo -e "${YELLOW}[3/6] Checking Rust files...${NC}"

    # Check rustfmt
    if ! command -v rustfmt &> /dev/null; then
        echo -e "${YELLOW}⚠️  rustfmt not found, skipping Rust format check${NC}"
        echo -e "${YELLOW}   Install with: rustup component add rustfmt${NC}"
    else
        echo -e "${BLUE}  Running rustfmt...${NC}"
        RUSTFMT_ISSUES=0
        for file in $RUST_FILES; do
            if [ -f "$file" ]; then
                # Check if file needs formatting
                if ! rustfmt --check "$file" 2>&1; then
                    echo -e "${RED}  ❌ Formatting issues in: $file${NC}"
                    RUSTFMT_ISSUES=1
                fi
            fi
        done

        if [ $RUSTFMT_ISSUES -eq 1 ]; then
            echo -e "${RED}❌ Rust formatting issues found!${NC}"
            echo -e "${YELLOW}Fix with: rustfmt <files>${NC}"
            FAILED=1
        else
            echo -e "${GREEN}✓ Rust files properly formatted${NC}"
        fi
    fi

    # Check clippy (if available)
    if command -v cargo &> /dev/null && command -v cargo-clippy &> /dev/null; then
        echo -e "${BLUE}  Running clippy...${NC}"
        if cargo clippy --all-targets -- -D warnings 2>&1; then
            echo -e "${GREEN}✓ Rust files pass clippy checks${NC}"
        else
            echo -e "${RED}❌ Clippy warnings found!${NC}"
            echo -e "${YELLOW}Fix clippy warnings before committing${NC}"
            FAILED=1
        fi
    elif command -v cargo &> /dev/null; then
        echo -e "${YELLOW}⚠️  clippy not found, skipping lint check${NC}"
        echo -e "${YELLOW}   Install with: rustup component add clippy${NC}"
    fi
else
    echo -e "${BLUE}[3/6] No Rust files modified, skipping Rust checks${NC}"
fi

echo ""

# ============================================================================
# 4. PDFium Unit Tests
# ============================================================================
echo -e "${YELLOW}[4/6] Checking PDFium unit tests...${NC}"

# Find the most recent build directory
LATEST_BUILD_DIR=$(find out -maxdepth 1 -type d -name "Test-*" 2>/dev/null | sort -r | head -1)

if [ -z "$LATEST_BUILD_DIR" ]; then
    LATEST_BUILD_DIR=$(find out -maxdepth 1 -type d 2>/dev/null | grep -v "^out$" | sort -r | head -1)
fi

if [ -n "$LATEST_BUILD_DIR" ] && [ -f "$LATEST_BUILD_DIR/pdfium_unittests" ]; then
    echo -e "${BLUE}  Found build: $LATEST_BUILD_DIR${NC}"
    echo -e "${BLUE}  Running pdfium_unittests...${NC}"

    if "$LATEST_BUILD_DIR/pdfium_unittests" --gtest_brief=1 2>&1 | tail -20; then
        echo -e "${GREEN}✓ PDFium unit tests passed${NC}"
    else
        echo -e "${RED}❌ PDFium unit tests failed!${NC}"
        FAILED=1
    fi
else
    echo -e "${YELLOW}⚠️  PDFium unit tests not built${NC}"
    echo -e "${YELLOW}   Build with:${NC}"
    echo -e "${YELLOW}     BUILD_ID=\"pre-commit-\$(git log -1 --format='%h')-\$(date +%Y%m%d-%H%M)\"${NC}"
    echo -e "${YELLOW}     BUILD_DIR=\"out/Test-\${BUILD_ID}\"${NC}"
    echo -e "${YELLOW}     gn gen \"\$BUILD_DIR\" --args=\"is_debug=false pdf_is_standalone=true\"${NC}"
    echo -e "${YELLOW}     ninja -C \"\$BUILD_DIR\" pdfium_unittests pdfium_embeddertests${NC}"
    echo -e "${YELLOW}   Continuing without running unit tests...${NC}"
fi

echo ""

# ============================================================================
# 5. Integration Tests (Smoke)
# ============================================================================
echo -e "${YELLOW}[5/6] Checking integration tests (smoke)...${NC}"

if [ -d "integration_tests" ]; then
    cd integration_tests

    # Check if pytest is available
    if ! command -v pytest &> /dev/null; then
        echo -e "${YELLOW}⚠️  pytest not found, skipping integration tests${NC}"
        echo -e "${YELLOW}   Install with: pip install pytest${NC}"
        cd "$REPO_ROOT"
    else
        # Check if PDFs directory exists
        if [ ! -d "pdfs" ]; then
            echo -e "${YELLOW}⚠️  PDFs directory not found, skipping integration tests${NC}"
            cd "$REPO_ROOT"
        else
            echo -e "${BLUE}  Running pytest -m smoke...${NC}"

            # Run smoke tests with timeout
            if timeout 60 pytest -m smoke --quiet --tb=no --no-header 2>&1 | tail -20; then
                echo -e "${GREEN}✓ Integration smoke tests passed${NC}"
            else
                EXIT_CODE=$?
                if [ $EXIT_CODE -eq 124 ]; then
                    echo -e "${RED}❌ Integration smoke tests timed out (>60s)${NC}"
                else
                    echo -e "${RED}❌ Integration smoke tests failed!${NC}"
                fi
                FAILED=1
            fi
            cd "$REPO_ROOT"
        fi
    fi
else
    echo -e "${YELLOW}⚠️  integration_tests directory not found${NC}"
fi

echo ""

# ============================================================================
# 6. Summary
# ============================================================================
echo -e "${BLUE}======================================${NC}"
if [ $FAILED -eq 0 ]; then
    echo -e "${GREEN}✓ All pre-commit checks passed!${NC}"
    echo -e "${BLUE}======================================${NC}"
    exit 0
else
    echo -e "${RED}❌ Pre-commit checks failed!${NC}"
    echo -e "${BLUE}======================================${NC}"
    echo ""
    echo -e "${YELLOW}To bypass this hook (not recommended):${NC}"
    echo -e "${YELLOW}  git commit --no-verify${NC}"
    echo ""
    exit 1
fi
