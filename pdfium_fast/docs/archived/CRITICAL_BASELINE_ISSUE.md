# CRITICAL: Baseline Regeneration is DANGEROUS

**User is RIGHT to be suspicious.**

---

## The Problem

**Original baselines (correct):**
- Generated from **upstream PDFium** (unmodified Google code)
- Commit: 7f43fd79 (2025-10-30)
- These are the GROUND TRUTH (what PDFium is supposed to produce)

**What happened:**
1. We added threading, form fixes, BGR mode, etc.
2. Our output changed (different from upstream)
3. Tests started failing (our output â‰  upstream baseline)
4. Worker "fixed" it by regenerating baselines to match OUR output
5. Tests now pass

**The danger:**
- If our output is WRONG, regenerating baselines hides the bug!
- Tests pass, but we're producing incorrect output
- We've lost the ground truth comparison

---

## Why Baselines Were "Correct in the Beginning"

**Original baselines:**
- Generated by running upstream PDFium (pure Google code)
- MD5 hashes of what CORRECT output looks like
- No modifications, no bugs, no optimizations

**Example:**
```bash
# Upstream PDFium renders arxiv_001.pdf page 0
# Output MD5: ce17d691924ef3ec91e9772a7b6d90c0
# This is the CORRECT output

# Our code renders same PDF
# Output MD5: 27f170ed748b6a151b3ed3e1002e447a
# This is DIFFERENT - is it correct or broken?
```

**We can't tell if we're correct by regenerating baselines!**

---

## What Regeneration Hides

**Scenario 1: Our code is broken**
```
Upstream: Renders blue sky (correct)
Our code: Renders red sky (BUG!)
Test: FAIL (red â‰  blue)

Regenerate baseline: Now expects red
Test: PASS (red == red)

Result: Bug hidden! We think we're correct but we're wrong!
```

**Scenario 2: Our code is correct**
```
Upstream: Renders with threading disabled
Our code: Renders with threading (slightly different AA)
Test: FAIL (different MD5)

Regenerate baseline: Now expects threaded output
Test: PASS

Result: False alarm, our code is fine
```

**We don't know which scenario we're in!**

---

## The CORRECT Solution

### Step 1: Visual Comparison (MUST DO)

**Compare our output to upstream visually:**

```bash
# 1. Build upstream PDFium (unmodified)
cd ~/upstream_pdfium
git checkout 7f43fd79
./setup.sh
ninja -C out/Release pdfium_test

# 2. Render same PDF with both
~/upstream_pdfium/out/Release/pdfium_test arxiv_001.pdf /tmp/upstream/
~/pdfium_fast/out/Release/pdfium_cli --ppm render-pages arxiv_001.pdf /tmp/ours/

# 3. Compare visually
open /tmp/upstream/page_0000.ppm
open /tmp/ours/page_0000.ppm

# 4. Are they visually identical?
# - YES: Our code is correct, MD5 differs due to minor changes (acceptable)
# - NO: Our code is BROKEN (must fix)
```

### Step 2: Decide Based on Visual Comparison

**If visually identical:**
- Our code is correct
- MD5 differs due to minor changes (threading, AA, etc.)
- Safe to regenerate baselines
- Accept our output as new ground truth

**If visually different:**
- Our code is BROKEN
- Must fix the bug
- Do NOT regenerate baselines
- Find and fix what's wrong

---

## My Suspicion

**Looking at the bug history:**

1. **N=41:** BGR mode (changed format)
2. **N=197:** Fixed K=1 vs K>1 (changed format back)
3. **N=200-202:** Added form rendering
4. **N=207:** More format fixes
5. **N=210:** Threading mutex changes

**Each of these CHANGED the output.**

**Question**: Are these changes making us closer to or further from upstream?

**Likely answer**:
- Threading changes (N=341, N=210): May cause minor differences (acceptable)
- Form rendering (N=200-202): Added feature upstream has? Or broke something?
- Format fixes (N=197, N=207): Attempted to match upstream but may have failed

---

## What We Should Do RIGHT NOW

### Option A: Visual Validation (RECOMMENDED)

**Test 10 random PDFs visually:**

```bash
# Pick 10 PDFs that are failing
FAILING_PDFS="arxiv_001 arxiv_002 arxiv_003 cc_001_931p ..."

for pdf in $FAILING_PDFS; do
  # Our output
  pdfium_cli --ppm --threads 1 render-pages integration_tests/pdfs/benchmark/$pdf.pdf /tmp/ours/

  # Compare to baseline (expected)
  baseline_md5=$(jq -r '.pages["0"]' integration_tests/baselines/upstream/images_ppm/$pdf.json)

  echo "$pdf:"
  echo "  Expected (upstream): $baseline_md5"
  echo "  Actual (ours): $(md5 /tmp/ours/page_0000.ppm)"
  echo "  Match: $(test $baseline_md5 == $(md5 /tmp/ours/page_0000.ppm) && echo YES || echo NO)"

  # Manual visual check
  open /tmp/ours/page_0000.ppm
  read -p "Does this look correct? (y/n) " answer
done
```

### Option B: Accept Divergence (RISKY)

**If we can't build upstream:**
- Accept that our output differs from upstream
- Regenerate baselines with our code
- **Risk**: May be hiding bugs

### Option C: Revert All Changes (SAFE)

**Nuclear option:**
- Revert to v1.6.0 (before BGR drama)
- v1.6.0 passed all tests with upstream baselines
- Start fresh without BGR/form changes

---

## My Recommendation

**DO NOT regenerate baselines blindly.**

**Instead:**
1. Pick 5-10 failing PDFs
2. Render with our code
3. Visual inspection: Does output look correct?
4. If looks good: Safe to regenerate
5. If looks wrong: We have a bug, must fix

**This is critical - we might be hiding bugs by updating baselines.**

**Worker should STOP full test run and do visual validation first.** ðŸš¨